```{r, echo=FALSE}
knitr::opts_chunk$set(error = TRUE)
```

# Outcome {#outcome}

This chapter focusses on the first application of the D-score: the D-score as neurocognitive outcome at 1000 days. In this chapter, we show how the D-score is calculated, demonstrate how to work with the D-score package, and how the D-score can be used as neurocognitive outcome in three different populations. First, the calculations behind the D-score are explained step-by-step and how to do this with the D-score package by means of two example children. Thereafter, the D-scores will be calculated for three different populations at the age of two years: the reference population, population of preterm children, and population of children in LMIC. 


## Application I: D-score as neurocognitive outcome at 1000 days

In the Netherlands, development of children is monitored by using the Dutch Developmental Instrument (DDI; in Dutch: Van Wiechenschema). The DDI consists of 76 items and a subset of these items are assessed at different ages, ranging from 1 month to 4.5 years old. To explain how the D-score is calculated and demonstrate the use of the D-score package two example children, both of the age of 15 months, are used. One of the example children is able to do all items of his/her age, and the other example child is not able to do all items of his/her age. In this way, we can show how different scores on a item affect the D-score.

So for example, for a child of the age of 15 months the Dutch Developmental Instrument consists of the following six items: puts cube in and out of a box, plays 'give and take', crawls (abdomen off the floor), walks along, understands a few words, and says 2 'sound-words' with comprehension. For each of these six items it is noted whether the child was able to perform this item. An example of the results can be found in table \@ref(tab:tableWS), in which *child 1* was able to perform all items and *child 2* was able to perform four of the six items. Based on these scores we can calculate the dscore for both these children.

```{r, echo=FALSE}
child1 <- c(15/12, 1, 1, 1, 1, 1, 1)
child2 <- c(15/12, 1, 0, 1, 1, 1, 0)
tableWS <- rbind(child1, child2)
colnames(tableWS) <- c("age in years", "item 1", "item 2", "item 3", "item 4", "item 5", "item 6")
rownames(tableWS) <- c("child 1", "child 2" )
#item2 : speelt geven/nemen
#item6 : loopt langs
```

```{r, tableWS, echo=FALSE}
library(knitr)
kable(tableWS, caption = "Example of scores on the items of the DDI at the age of 15 months", booktabs = TRUE)
```

Calculation of the D-score is an iterative procedure, in which in each step information of one item is added. The iterative procedure uses Bayes rule to update the prior (knowledge) with data to calculate a posterior. In the next step, this posterior is used as the prior and information, the score, from a new item is added. This results in a new posterior distribution. When the information of all items have been added to the procedure, the D-score is equal to the mean of the final posterior distribution. 

*!!plafond prior nog uitleggen!!*

In the first step, the score of the first item is combined with the prior. However, at the first step we cannot use the previous posterior as our prior. Hence, we need a starting distribution to use as the prior in the first step. It is important that this starting distribution is a bit informative but not too much, so it was decided to choose a quite broad distribution which was centred quite well. The prior was chosen in such a way that the mean value of the prior distribution was equal to the median D-score at that age. The standard deviation is equal to 5, which about twice the normal variation in the D-score.

The starting distributions (priors) for the ages of 1, 15 and 24 months are given in figure \@ref(fig:figpriors). This figure shows that the priors assume that ability of a child of the age of 1 month is lower than the ability of a child of the age of 15 months, which in turn is lower than the ability of a child of the age of 24 months. 

```{r, figpriors, echo = FALSE,  fig.cap="\\label{fig:figpriors} Priors at ages of 1, 15 and 24 months"}
library(dscore)
#example from the adp function:
qp <- -10:80
plot(x = qp, y= adp(1/12, qp), type = "l", 
  main = "Priors at ages of 1, 15 and 24 months", 
  ylab = "Density", xlab = "D-score")
lines(x = qp, adp(1.25, qp), lty = 2)
lines(x = qp, adp(2, qp), lty = 3)
```

First, it is important that the names of the items used are similar to the names of the items in the built-in item bank. In this example the lexicon *gcdg* is used. Moreover, the data should be in long format with the following columnnames: *items*, *scores* and *ages*. This leads to table \@ref(tab:tablenewWS1).

```{r, tablenewWS1, echo=FALSE}
WS1 <- data.frame(child = c("child 1", "child 1", "child 1", "child 1", "child 1", "child 1", "child 2", "child 2", "child 2", "child 2", "child 2", "child 2"),items = c("n32", "n33", "v38", "n37", "n34", "n35", "n32", "n33", "v38", "n37", "n34", "n35"), scores = c(1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0), ages = c(15/12, 15/12, 15/12, 15/12, 15/12, 15/12, 15/12, 15/12, 15/12, 15/12, 15/12, 15/12))

kable(WS1, caption = "Long format of the example of scores on the items of the DDI at the age of 15 months", row.names = NA)
```

Now that the data is in long format and the item names are changed to the lexicon *gcdg*, we can calculate the D-score for both children. In the first step of the iterative procedure, we combine the age-dependent prior of 15 months with the score of the first item *n34* to define the posterior. Item *n34* is a gross motor item: 'crawls, abdomen off the floor'. In table \@ref(tab:tablenewWS1), we can see that both example children were able to crawl with their abdomen off the floor. Note, that we could have chosen any of the items as the first item, since the D-score is independent of the order of items in the calculation. 

The age dependent prior of 15 months and the posterior distribution after adding information from item *n34* are given in figure \@ref(fig:fig1item). In this figure, we can see that the posterior distribution doesnot differ that much from the prior distribution. Both distributions are centred at the same point, while the posterior distribution is smaller than the prior distribution indicating more precision. Since both example children were able to crawl with their abdomen off the floor, the posterior distribution after the first step of the procedure is equal. 

```{r, fig1item, echo=FALSE, fig.cap="\\label{fig:fig1item} Age-dependent priors of 15 months and posterior after 1st item n34"}
items <- c("n34")
age <- 1.25
  
#full posterior 1e item
fp <- dscore(1, items, age, full = TRUE, lexicon = "gcdg")
plot(fp[[1]]$qp, fp[[1]]$posterior, type = "l", lty = 1,
xlab = "D-score", ylab = "Density", 
main = "Age 15 months: 1 PASS at n34")
lines(fp[[1]]$qp, fp[[1]]$start, lty = 2)
legend(0.04, 0.08, c("posterior", "prior"), lty = c(1, 2), 
       merge = TRUE)
```

Now, let's add an item on which the scores for the two example children differ, e.g. item *n35*. Item *n35* is also a gross motor item, namely 'walks along'. So both children are able to crawl (with their abdomen of the floor), but only *child 1* is able to walk along. We can use the previously calculated posterior distribution as prior when we add item *n35*. 

Let's start with *child 1*, who is able to walk along. Using Bayes rule, the new posterior distribution can be calculated. In figure \@ref(fig:fig2itemC1) the prior, in this case the posterior after adding item *n34* to the age-dependent prior, and the newly calculated posterior distribution are visualized. Again, the posterior and prior are centred around the same point, while the posterior has a bit more precision.

```{r, fig2itemC1, echo=FALSE, fig.cap="\\label{fig:fig2itemC1} Prior and posterior in the 2nd step of the iterative process for child 1"}
items <- c("n34", "n35")
age <- rep(1.25, length(items))
  
#full posterior 2e item
fp2 <- dscore(c(1,1), items, age, full = TRUE, lexicon = "gcdg")
plot(fp[[1]]$qp, fp2[[1]]$posterior, type = "l",
xlab = "D-score", ylab = "Density", 
main = "Age 15 months: PASS at n34 and n35 (child 1)", col = "red")
lines(fp[[1]]$qp, fp[[1]]$posterior, lty = 2)
legend(0.04, 0.08, c("posterior child 1", "prior"), lty = c(1, 2), 
       col = c("red","black"),merge = TRUE)

```

Now we can do the same thing for *child 2*, who is able to crawl with his/her abdomen off the floor (*n34*) but not to walk along (*n35*). Again, we can use the posterior after adding information from *n34* as the prior and use the information from *n35* to calculate the posterior. In figure \@ref(fig:fig2itemC2) the prior and posterior are given. Now the prior and posterior are different, the posterior is on the left of the prior and has an high precision in comparison to the prior. Hence, being unable to walk along at the age of 15 months, like *child 2*, is more indicative for the development of a child of 15 months than being able to walk along like *child 1*. 

```{r, fig2itemC2, echo=FALSE, fig.cap="\\label{fig:fig2itemC2} Prior and posterior in the 2nd step of the iterative process for child 2"}
items <- c("n34", "n35")
age <- rep(1.25, length(items))
  
#full posterior 2e item FAIL
fp2 <- dscore(c(1,0), items, age, full = TRUE, lexicon = "gcdg")
plot(fp[[1]]$qp, fp2[[1]]$posterior, type = "l",
xlab = "D-score", ylab = "Density", 
main = "Age 15 months: PASS at n34 and FAIL at n35 (child 2)", col = "blue")
lines(fp[[1]]$qp, fp[[1]]$posterior, lty = 2)
legend(0.15, 0.23, c("posterior child 2", "prior"), lty = c(1, 2), 
       col = c("blue","black"),merge = TRUE)

```


The next four steps in the iterative procedure, information from the other four items (*n32*, *n33*, *v38* and *n37*) can be added in a similar fashion. Figure \@ref(fig:fig6itemC1C2) shows the final posterior distributions for *child 1* and *child 2* and the prior distribution for the age of 15 months. The D-score can now be determined by looking at the mean of the posterior distributions. Hence, the D-score for *child 1* and *child 2* are equal to 55.75 and 47.76, respectively.

```{r, fig6itemC1C2, echo=FALSE, fig.cap="\\label{fig:fig6itemC1C2} Prior and final posterior for child 1 and 2"}
items <- c("n32", "n33", "v38", "n37","n34", "n35")
age <- rep(1.25, length(items))
  
#full posterior for both children and prior
fp6_1 <- dscore(c(1,1,1,1,1,1), items, age, full = TRUE, lexicon = "gcdg")
fp6_2 <- dscore(c(1,0,1,1,1,0), items, age, full = TRUE, lexicon = "gcdg")
plot(fp[[1]]$qp, fp6_2[[1]]$posterior, type = "l",
xlab = "D-score", ylab = "Density", 
main = "Age 15 months: D-scores for child 1 and child 2", col="blue")
lines(fp[[1]]$qp, fp6_1[[1]]$posterior, col = "red")
lines(fp[[1]]$qp, fp[[1]]$start, lty = 2)
legend(0.15, 0.3, c("posterior child 2", "posterior child 1","prior 15 months"), lty = c(1, 1, 2), 
       col = c("blue", "red","black"),merge = TRUE)

```

```{r}
#Dscore child1
dscore(c(1,1,1,1,1,1), items, age, full = FALSE, lexicon = "gcdg") #55.75
#Dscore child2
dscore(c(1,0,1,1,1,0), items, age, full = FALSE, lexicon = "gcdg") #47.76
```

*nog toe te voegen in de tekst*

*quadratic points*

*Note: met deze methode is het mogelijk om scores voor extremen te berekenen, andere methodes (zoals de worms estimator) kunnen dit niet altijd.*

*Prior die gekozen was: plafond prior (wanneer je alle items kan)*




## D-score of reference children at 2 years (MG)

**Data**

A reference sample was obtained from the Social Medical Survey of Children Attending Child Health Clinics (SMOCC) cohort, a nationally representative cohort of 2,151 children born in The Netherlands during 1988–1989 [@herngreen1994growth] . Of this cohort, general characteristics and developmental milestones of the Dutch Development Instrument at 2y of age (range 22-26 months) were available for 1,583 children. 


**Statistical analyses**

Several characteristics were selected from the SMOCC cohort.  The following indicators are in agreement with the Global Indicators Project:

- Area of residence:
    - rural: <2,000 inhabitants
    - semi-urban: [2000, 50,000] inhabitants
    - urban: 50,000 – 1 million inhabitants
    - metropolitan: >1 million

-	Number of years of education by the mother (in years)
-	Child related factors:
     - Gestational age (In weeks and in categories of very preterm (<32 weeks), preterm (<37 weeks) and term birth (≥37 weeks))
     - Gender (boys vs girls)
     - Birthweight (in grams)
     -	Birth size (in cm) 


We also added the following indicators from the SMOCC study:

-	Paternal education (in years)
-	Maternal age (in years)
-	Apgar score after 1 min < 5 (yes vs no)
-	Apgar score after 5 min < 7 (yes vs no)


**Results**

```{r, echo=FALSE}

resultsSMOCC <- data.frame(a = c("Area of Residence","rural", "semi-urban" , "urban", "metropolitan", "Maternal education (in years)", "Paternal education (in years)", "Maternal age (in years)", "Gestational age (in weeks)", "Gestational age (in categories)", "$\\geq 37$ weeks", "$\\geq 32 - 37$ weeks", "$<32$ weeks*", "Gender", "boys", "girls", "Birthweight (in kg)","Birthweight (in categories)", "$\\geq 2500$ grams", "$\\geq 1500 - <2500$ grams", "$<1500$ grams", "Birth size (in cm)", "Apgar score after 1 min", "$<5$", "$\\geq 5$", "Apgar score after 5 min", "$<7$", "$\\geq 7$"), 
                b = c(" ","$15$", "$1262$" , "$294$", "$0$", "$1564$", "$1560$", "$1582$", "$1583$", " ", "$1500$", "$78$", "$5$", " ", "$771$", "$812$", "$1583$"," ", "$1490$", "$85$", "$8$", "$1383$", " ", "$29$", "$1306$", " ", "$15$", "$1339$"),
                c = c( " ","$1.0%$", "$80.3%$" , "$18.7%$", "$0.0%$", "$13 (2.3)$", "$14 (2.6)$", "$30 (4.5)$", "$40 (1.8)$", " ", "$94.8%$", "$4.9%$", "$0.3%$", " ", "$51.0%$", "$49.0%$", "$3.419 (0.559)$"," ", "$94.1%$", "$5.4%$", "$0.5%$", "$51 (2.6)$", " ", "$2.2%$", "$97.8%$", " ", "$1.1%$", "$98.9%$"),
                d = c(" ","$0.284 (0.247)$", "$0$", "$0.0719 (0.062)$", " ", "$0.0802 (0.0102)$", "$0.0538 (0.0092)$", "$0.0005 (0.0054)$", "$0.0676 (0.0130)$", " ", "$0$", "$-0.3788 (0.1097)$","$-1.2846 (0.4233)$", " ", "$-0.2904 (0.0473)$", "$0$", "$0.1226 (0.0427)$"," ", "$0$", "$-0.2456 (0.1056)$", "$-0.9539 (0.3358)$", "$0.0165 (0.0097)$", " ", "$0.0524 (0.1752)$", "$0$", " ", "$0.1497 (0.2420)$", "$0$"),
                e = c(" ","$1.15$", " " , "$1.17$", " ", "$7.83$", "$5.83$", "$0.10$", "$5.20$", " ", " ", "$-3.45$", "$-3.03$", " ", "$-6.15$", " ", "$2.87$"," ", " ", "$-2.33$", "$-2.84$", "$1.70$", " ", "$0.3$", " ", " ", "$0.62$", " "),
               f = c(" ","$0.25$", " " , "$0.24$", " ", "$<.001$", "$<.001$", "$0.92$", "$<.001$", " ", " ", "$<.001$", "$0.002$", " ", "$<.001$", " ", "$0.0041$"," ", " ", "$0.0202$", "$0.0046$", "$0.089$", " ", "$0.76$", " ", " ", "$0.54$", " "))


knitr::kable(resultsSMOCC, caption = "Results SMOCC", booktabs = TRUE, digits = 4, col.names = c("Indicators","n","$%$ or mean(SD)", "Model DAZ Coefficient (SE)","Model DAZ t-statistics","Model DAZ p-value"))
```


```{r, echo=FALSE}
#Script van Stef:
library("ddata")
library("dscore")
library("dmetric")
studies <- c("Netherlands 1", "Netherlands 2")
data <- get_gcdg(study = studies, min_cat = 10, adm = TRUE, cov = TRUE)
items <- intersect(item_names(study = studies), names(data))
nlbank <- dscore::itembank
d_dutch <- calculate_dscore(data = data, items = items, 
                            itembank = nlbank, lexicon = "gcdg")
ref <- dscore::gcdg_reference
d_dutch$daz <- with(d_dutch, dscore::daz(d = d, x = age / 12, ref = ref))
n_items <- data.frame(id = data$id, age = data$age,
                      n = rowSums(!is.na(data[, items])))
d_dutch <- dplyr::left_join(d_dutch, n_items, by = c("id", "age"))
with(d_dutch, (plot(age, d, cex = 0.6)))
with(d_dutch, (plot(age, daz, cex = 0.6)))
write.table(x = d_dutch, file = "notes/dutch_native.txt",
            sep = "\t", na = "", row.names = FALSE, quote = FALSE)

```




## D-score of pre-terms at 2 years (PD)

## D-score of children in LMIC at 2 years (RO)

## Comparison
