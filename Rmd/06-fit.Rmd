# Interpretation of item fit {#ch:itemfit}

<!--5.2
formules eerder achterin, of uitleggen
terugverwijzen
zeggen dat je zowel visueel als met fitmaat kunt werken
item namen = gsed

bespreken van verschillende voorbeelden, plat, te steil
n26 is steiler, hoe erg is dat?
is er ook een vlakker item
figuur aspect ratio, compacter maken, nu te hoog, combineren mogelijk?
kunnen we ook de observaties tonen, rugplot?
#voorbeelden gedragstoestand tijdens van wiechenschema als items nemen en laten zien als illustratie van slechte items. Of niet geselecteerde items.

5.3 
Interpretation van infit en outfit komt te vroeg
laat eerst zien wat beide zijn
E_ni -> P_ni
Plaatje van de (gestandardiseerde) residuen?

5.4 
psychometric information?
-->

Richtlijnen interpretatie Person fit > 3? item fit >1 /1.2
## SMOCC data: design

To illustrate the interpretation of fit measures for the D-score we use the SMOCC study [@herngreen1994], which covers the age range 0-2 years. In the SMOCC study 57 items are asssesed to measure the D-score. 

```{r, include=FALSE}
library(ddata)
library(dmetric)
library(dscore)
library(sirt)
```


## Empirical and fitted item response curves

An imporant aspect of the Rasch analysis is the issue of model fit. Actually, for the Rasch model it is not the task of the model to account for the data, however it is the task of the data to fit the Rasch model. Accordingly, the model fit determines how well emprirical data meets the requirement of the Rasch model. The fit of the data to a Rasch model can be visually inspected by comparing the observed probability of endorsing an item to the fitted item response curve for endorsing the item. The fitted item response curve for each item $i$ is modeled as: $$P_{ni}= \frac{exp( \beta_{n} - \delta_{i} )}{1+exp(\beta_{n}-\delta_{i})}$$ where $\beta_n$ is the ability of person $n$ and $\delta_i$ is the difficulty of item $i$. In the Figure below, the item characteristics curve can be obverved for an example item "n26" and item "n40". It can be observed that for both items the observed data (orange line) fits nicely to the estimated item response curve (dashed line).  


```{r icc, include=FALSE, message=FALSE, warning=FALSE}

smocc <- get_gcdg(study="Netherlands 1", adm = TRUE)
smocc$age <- smocc$age/12
varlist <- prepare_items(study = "Netherlands 1")
equatelist <- prepare_equates(varlist)
model_name<- "smocc"
sm1 <- fit_dmodel(varlist=varlist,equate=equatelist, name = model_name)
plots <- plot_p_ability_item(data=smocc, model = sm1, metric="logit")
#plots <- plot_p_ability_item(data=smocc, model = sm1, metric="dscore")


## hier gaat het nog steeds verkeerd met het plotten van de pass voor ability (observed) abilities lijkt overschat in data in vergelijking tot difficulty in model.. 
# data <- smocc
# model <- sm1
#   data <- left_join(data, model$beta_l)
#     delta <- model$fit$item[,"b"]
#     names(delta) <- rownames(model$fit$item)
#     delta <- delta[items]
#     beta_breaks <- seq(-15,25,1)
#     xlim <-c(-15,25)
#     scale <- 1
#   items <- model$items
# 
# pass <- data %>%
#     gather(key = item, value = value, items) %>%
#     drop_na(item, value, b) %>%
#     mutate(bgp = cut(b, breaks = beta_breaks)) %>%
#     group_by(item, study, bgp) %>%
#     summarise(p = round(100 * mean(value, na.rm = TRUE)),
#               a = mean(age, na.rm = TRUE),
#               b = mean(b, na.rm = TRUE),
#               n = n()) %>%
#     ungroup %>%
#     mutate(rug = FALSE) %>%
#     left_join(ddata::get_itemtable(items), by = "item")

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
plots[["n26"]]
plots[["n40"]]
```


## Item fit

The fit of the items evaluate the extent to which data performs with the construction of measurement. An assumption of the Rasch model is that items with a lower difficulty will always have a higher probability to pass in comparison to items with a higher difficulty level. Fit analysis evaluates the extend to which this is true for each item. Two types of item fit are distinguished: the item outfit and the item infit. The outfit evaluates the extent to which the responses to the items are consistent with the model. In other words wheter items with a lower difficulty also have a higher probability to pass. The outfit statistic is heavity infulenced by outlying responses that do not fit the expected pattern. The infit is the information weighted fit and is more sensitive to inlying, on-target, unexpected responses. 

To determine the fit of items to the model we compare the observed responses and the expected values. The observed response $x_{ni}$ of person $n$ on item $i$ can be $0$ or $1$. The expected response $P_{ni}$ is modelled as $$E_{ni}= \frac{exp( \beta_{n} - \delta_{i} )}{1+exp(\beta_{n}-\delta_{i})}$$. The difference between the observed and the expected responses are the residual errors. The item infit is the sum of the squared errors divided by the sum of the expected response variances $W_{ni}$. The expected response variance $W_{ni}$ can be obtained as $E_{ni}(1-E_{ni})$. The outfit is calculated as the sum of the squared standardizes errors. The residual errors are standardized by dividing by the expected binomial standard deviation: $$z_{ni} = \frac{x_{ni}-E_{ni}}{\sqrt{W_{ni}}}$$ 
Accordingly the infit and outfit are calculated as: $$Infit = \frac{\sum_{n}^N (x_{ni}-E_{ni})^2}{\sum_n^N W_{ni}}$$
$$Outfit = \frac{\sum_{n}^N z_{ni}^2}{N}$$

In the figure below an item with a large outfit is presented as well as an item with a large infit. 

```{r include=FALSE, message=FALSE, warning=FALSE}
N <- 500    # number of persons
I <- 5      # number of items
b <- seq( -2, 2, length=I)
th <- rnorm(n=N)
set.seed(121212)
dat <- sirt::sim.raschtype(th, b ,fixed.a=c(0,0,5,0,0)) #add a large positive slope for item 3
colnames(dat) <- paste0( "I", 1:I )
items <- colnames(dat)
dat$age <- rnorm(N, 1, 1)
dat$id <- 1:N
itemtable <- data.frame(item = items)
#2PL functie data maken (platte bijv sociall emo en hele stijlen)
# model1 <- fit_raschmodel(data = dat, items = items, itemtable = itemtable,equate = NULL, age_unit = "years")
#model1$item_fit
#model1$beta_l
#outfit impute 1s for person with lower ability than item ability
# plots3 <- plot_p_ability_item(data=dat,model=model1, metric = "logit")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}

# plots3[[3]]

```

##HIER EVENTUEEL PERSON FIT FORMULAS INVOEGEN


## Different item functioning (DIF)

An important aspect of item fit to the Rasch model is the assumption that items have the same difficulty in different subgroups of respondents, which is called Differential Item Functioning (DIF). Zumbo (1999) describes a clear definition: "DIF occurs when examinees from different groups show differing probabilities of success on (or endorsing) the item after matching on the underlying ability that the item is intended to measure." [@zumbo1999] The examination of DIF can be done by modelling the probability of endorsing an item in a logistic regression model by the ability from the Rasch model and a grouping variable. When the grouping variable significantly explains residual variance of the item scores after adjusting for the ability, the item presents DIF for that group. 


```{r dif}
head(sm1$beta_l)

#make dataframe with covariates, b, and pass



```

## Item information at a given ability

The item information can be calculated as the amount of psychometric information an item contains for a given ability. The formula for the item information is the first derivative of the item response curve and can be written as follows: $$I(\delta)=P_i(\delta)(1-P_i(\delta))$$ where $P_i(\delta)$ is the conditional probability of endorsing an item. For example for item n40 "Says three words" the $\delta_i$ equals $3.47$. The probability of endorsing this item for a person with an ability level of $2$ standard deviation above the mean is $$P_{ni}= \frac{exp(2 -  3.47)}{1+exp(2-3.47)}$$ $$P_{ni}= 0.19$$
So for an ability level of $2$ standard deviations above the mean $\beta_n=2$, item n40 has an information value of $$I(\delta)=0.19(1-0.19)$$ $$I(\delta)=0.15$$ 
In the Figure below, the item information curves for item n26 and n40 are displayed. The implications of the item information is that the amount of information an item provides is maximized around the item-difficulty parameter. 

```{r echo=FALSE, message=FALSE, warning=FALSE}

#item information curve
## bereken item info by difficulty
 info <- function(beta, delta) {(exp(beta-delta)/(1+exp(beta-delta)) * (1-exp(beta-delta)/(1+exp(beta-delta))))}
 delta <- sm1$fit$b["n26"]
 betar <- c(-7,2)
 beta = seq(betar[1], betar[2], length = 200)
 iteminfo26 <- data.frame(ability=beta,I=info(beta,delta))

 delta <- sm1$fit$b["n40"]
 betar <- c(-2,7)
 beta = seq(betar[1], betar[2], length = 200)
 iteminfo40 <- data.frame(ability=beta,I=info(beta,delta))


 iteminfo26$item <- "n26"
 iteminfo40$item <- "n40"
 df <- rbind(iteminfo26,iteminfo40)
 ggplot(df, aes(ability,I, group=item, color=item))+geom_line()+xlab("Ability")+ylab("Item information")

```


## Item information at a given age

The item information can also be expressed against age. By doing so, one can identify at what age an item provides the most information.  


```{r}
calculate_age_equivalents <- function(model,
                                      p = c(10, 50, 90),
                                      reference = dscore::gcdg_reference) {
  if (!inherits(model, "dmodel"))
    stop ("Argument `model` not of class `dmodel`")

  ib <- model$itembank
  scalefactor <- model$transform[2]
  pd <- matrix(ib$tau, nrow = nrow(ib), ncol = length(p)) +
    matrix(scalefactor * qlogis(p / 100),
           nrow = nrow(ib), ncol = length(p), byrow = TRUE)
  pa <- approx(x = reference$mu, y = reference$month, xout = as.vector(pd))$y
  pa <- matrix(pa, ncol = 3)
  pda <- data.frame(ib$lex_gcdg, round(pd, 2), round(pa, 2))
  names(pda) <- c("item", paste0("D", p), paste0("A", p))
  pda
}

```

```{r echo=FALSE, message=FALSE, eval=FALSE}
colnames(sm1$dscore)[7] <-"b"
#model in logit
refs<- calculate_references(model = sm1, metric="logit")
refs$month <- refs$age
model$transform

calculate_age_equivalents(model=sm1, p=50, reference=refs)

```



The item information at a given age, can ultimately help determine at what age the item can best be administered. The item will be most informative, when adiminered at the age at which 50% of the respondents will pass the item. Administering the item at this age can be helpful when the item is used in an instrument to determine the ability of a population. However, when the item is used in a screening instrument, the goal would be to identify respondents that underperform compared to a norm group. In that case, the item can best be asessed at the age where 90% of respondents will pass the item. 


## Person fit

The fit of the persons evaluates the extent to which the responses of any person conform to the Rasch model expectation. The Rasch model expects that a more able person has a greater probabilty to pass any item than a less able person. Fit analysis evaluates the extend to which this is true for any person. Two types of person fit are distinguished: the person outfit and the person infit. The outfit evaluates the extent to which the responses to of the persons are consistent with the model. In other words wheter persons with a lower ability also have a lower probability to pass items. The outfit statistic is heavily infulenced by outlying responses that do not fit the expected pattern. The infit is the information weighted fit and is more sensitive to inlying, on-target, unexpected responses. 

To determine the fit of persons to the model we compare the observed responses and the expected values. The observed response $x_{ni}$ of person $n$ on item $i$ can be $0$ or $1$. The expected response $E_{ni}$ is modelled as $$E_{ni}= \frac{exp( \beta_{n} - \delta_{i} )}{1+exp(\beta_{n}-\delta_{i})}$$. The difference between the observed and the expected responses are the residual errors. The person infit is the sum of the squared errors divided by the sum of the expected response variances $W_{ni}$. The expected response variance $W_{ni}$ can be obtained as $E_{ni}(1-E_{ni})$. The outfit is calculated as the sum of the squared standardizes errors accumulated over the items $L$ to evaluate the plausability of any person response. The residual errors are standardized by dividing by the expected binomial standard deviation: $$z_{ni} = \frac{x_{ni}-E_{ni}}{\sqrt{W_{ni}}}$$. Accordingly the infit and outfit are calculated as: $$Infit = \frac{\sum_{n}^L (x_{ni}-E_{ni})^2}{\sum_n^L W_{ni}}$$
   $$Outfit = \frac{\sum_{n}^L z_{ni}^2}{L}$$. 

## hele inconsistente kinderen toevoegen als voorbeeld. eerst lopen en dan staan. 
